<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Installing nginx GeoIP2 on Ubuntu | Ivan Dokov - Web Expert</title>
    <meta name="description" content="Build nginx from source with GeoIP2 module">
    
    
    <link rel="preload" href="/assets/css/1.styles.48051fd0.css" as="style"><link rel="preload" href="/assets/js/app.c1ca0c5b.js" as="script"><link rel="preload" href="/assets/js/4.4666041f.js" as="script"><link rel="preload" href="/assets/js/21.f2062736.js" as="script"><link rel="prefetch" href="/assets/js/0.57638b5b.js"><link rel="prefetch" href="/assets/js/10.ec6f4743.js"><link rel="prefetch" href="/assets/js/11.8f1a5de8.js"><link rel="prefetch" href="/assets/js/12.5f9c53fb.js"><link rel="prefetch" href="/assets/js/13.5d070218.js"><link rel="prefetch" href="/assets/js/14.eb8b12f8.js"><link rel="prefetch" href="/assets/js/15.92060992.js"><link rel="prefetch" href="/assets/js/16.35dbd350.js"><link rel="prefetch" href="/assets/js/17.94a2ae83.js"><link rel="prefetch" href="/assets/js/18.874a408a.js"><link rel="prefetch" href="/assets/js/19.83a492d7.js"><link rel="prefetch" href="/assets/js/20.4945a147.js"><link rel="prefetch" href="/assets/js/22.466ef15f.js"><link rel="prefetch" href="/assets/js/23.8df8967a.js"><link rel="prefetch" href="/assets/js/3.8bfd5d75.js"><link rel="prefetch" href="/assets/js/5.bd4b597c.js"><link rel="prefetch" href="/assets/js/6.4322c3b6.js"><link rel="prefetch" href="/assets/js/7.670c1764.js"><link rel="prefetch" href="/assets/js/8.6cc13bdb.js"><link rel="prefetch" href="/assets/js/9.80ebb135.js">
    <link rel="stylesheet" href="/assets/css/1.styles.48051fd0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="wrapper"><header class="header"><div class="container"><a href="/" class="logo router-link-active"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 199.6 55.5"><path fill="#4385ef" d="M15.2 55.5c-3.7-1-6.3-2.7-7.9-5S5 45.5 5 42.3v-5.8c0-1.9-.4-3.3-1.2-4.4-.8-1-2.1-1.6-3.8-1.6v-5.7c1.7 0 3-.5 3.8-1.5.8-1 1.2-2.4 1.2-4.3v-5.8c0-3.2.8-6 2.4-8.2 1.6-2.3 4.2-3.9 7.9-5l1.6 4.5c-1.6.6-2.7 1.6-3.4 3.1-.7 1.5-1 3.4-1 5.6V19c0 2-.4 3.7-1.3 5.2-.8 1.5-2.1 2.7-3.8 3.6 1.7.9 3 2.1 3.8 3.6.8 1.5 1.3 3.2 1.3 5.2v5.8c0 2.2.3 4.1 1 5.6s1.8 2.5 3.4 3.1l-1.7 4.4z"></path><path fill="#3F454C" d="M21.7 48.3V7h14.2c5 0 9.2 1.6 12.5 4.8 3.3 3.2 4.9 7.4 4.9 12.4V31c0 5.1-1.6 9.2-4.9 12.4-3.3 3.2-7.4 4.8-12.5 4.8H21.7zM30 13.4v28.5h5.5c3 0 5.3-1 7-3 1.7-2 2.5-4.6 2.5-7.9v-6.9c0-3.2-.8-5.8-2.5-7.8s-4-3-7-3H30zM57.8 32.7c0-4.6 1.3-8.3 3.8-11.2 2.6-2.9 6.1-4.4 10.6-4.4s8.1 1.5 10.7 4.4 3.9 6.7 3.9 11.3v.6c0 4.6-1.3 8.4-3.8 11.3-2.6 2.9-6.1 4.4-10.6 4.4s-8.1-1.5-10.7-4.4c-2.6-2.9-3.8-6.7-3.8-11.3v-.7zm8.2.6c0 2.8.5 5 1.5 6.7 1 1.7 2.6 2.5 4.8 2.5 2.1 0 3.7-.9 4.7-2.5 1-1.7 1.5-3.9 1.5-6.7v-.6c0-2.7-.5-4.9-1.5-6.7-1-1.7-2.6-2.6-4.7-2.6s-3.7.9-4.7 2.6c-1 1.7-1.5 3.9-1.5 6.6v.7zM102.4 35.5h-2.3v12.9h-8.3V4h8.3v25.1h2l7.1-11.5h9.6L109 31.5l11.3 16.8h-9.5l-8.4-12.8zM121.7 32.7c0-4.6 1.3-8.3 3.8-11.2 2.6-2.9 6.1-4.4 10.6-4.4s8.1 1.5 10.7 4.4 3.9 6.7 3.9 11.3v.6c0 4.6-1.3 8.4-3.8 11.3-2.6 2.9-6.1 4.4-10.6 4.4s-8.1-1.5-10.7-4.4c-2.6-2.9-3.8-6.7-3.8-11.3v-.7zm8.3.6c0 2.8.5 5 1.5 6.7 1 1.7 2.6 2.5 4.8 2.5 2.1 0 3.7-.9 4.7-2.5 1-1.7 1.5-3.9 1.5-6.7v-.6c0-2.7-.5-4.9-1.5-6.7-1-1.7-2.6-2.6-4.7-2.6s-3.7.9-4.7 2.6c-1 1.7-1.5 3.9-1.5 6.6v.7zM166.4 36.9l.5 2.8h.2l.6-2.8 5-19.3h8.7L171 48.3h-8l-10.4-30.7h8.7l5.1 19.3z"></path><path fill="#4385ef" d="M182.8 51c1.6-.6 2.7-1.6 3.4-3.1.7-1.5 1-3.4 1-5.6v-5.8c0-2 .4-3.7 1.3-5.2s2.2-2.7 4-3.5c-1.8-.9-3.1-2-4-3.6-.9-1.5-1.3-3.3-1.3-5.3v-5.8c0-2.2-.3-4.1-1-5.6s-1.8-2.5-3.4-3.1l1.6-4.5c3.7 1 6.3 2.7 7.9 5 1.6 2.3 2.4 5 2.4 8.2V19c0 1.9.4 3.4 1.2 4.4.8 1 2.1 1.5 3.8 1.5v5.7c-1.7 0-3 .5-3.8 1.6-.8 1-1.2 2.5-1.2 4.4v5.8c0 3.2-.8 6-2.4 8.3-1.6 2.3-4.2 3.9-7.9 5l-1.6-4.7z"></path></svg></a> <a href="/" class="nav-link router-link-active router-link-exact-active">Blog</a> <a href="/about/" class="nav-link">About</a> <a href="https://github.com/ivandokov" target="_blank" class="nav-link icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg></a> <a href="https://twitter.com/ivandokov" target="_blank" class="nav-link icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"></path></svg></a> <a href="#" class="nav-link icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 .02c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.99 6.98l-6.99 5.666-6.991-5.666h13.981zm.01 10h-14v-8.505l7 5.673 7-5.672v8.504z"></path></svg></a> <a href="/rss.xml" class="nav-link icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm-3.374 17c-.897 0-1.626-.727-1.626-1.624s.729-1.624 1.626-1.624 1.626.727 1.626 1.624-.729 1.624-1.626 1.624zm3.885 0c-.03-3.022-2.485-5.474-5.511-5.504v-2.406c4.361.03 7.889 3.555 7.92 7.91h-2.409zm4.081 0c-.016-5.297-4.303-9.571-9.592-9.594v-2.406c6.623.023 11.985 5.384 12 12h-2.408z"></path></svg></a></div></header> <div class="container"><div class="content-grid"><aside class="sidebar"><div class="search-box-wrapper"><div class="search-box has-suggestions"><input aria-label="Search" autocomplete="off" spellcheck="false" placeholder="Search ..." value=""> <ul class="suggestions align-right"></ul></div> <!----></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="router-link-active"><span>All posts</span> <span class="item-count">5</span></a></div> <div class="nav-item"><a href="/bootstrap/"><span>Bootstrap</span> <span class="item-count">1</span></a></div><div class="nav-item"><a href="/depy/"><span>Depy</span> <span class="item-count">1</span></a></div><div class="nav-item"><a href="/servers/" class="router-link-active router-link-exact-active"><span>Servers</span> <span class="item-count">1</span></a></div><div class="nav-item"><a href="/tools/"><span>Tools</span> <span class="item-count">2</span></a></div></nav></aside> <main class="main"><div class="content-body"><div class="content__default"><h1 id="nginx-with-geoip2-on-ubuntu"><a href="#nginx-with-geoip2-on-ubuntu" class="header-anchor">#</a> Nginx with GeoIP2 on Ubuntu</h1> <p>In the web you can find a lot of tutorials how to use the GeoIP module for nginx but Maxmind - the company that is providing the database for countries and cities is deprecating their old database format <strong>dat</strong> and replacing it with a new format - <strong>mmdb</strong>. The nginx setup for this new format is different and requires building the module from source since there is no official support for nginx provided by the company as stated in their <a href="https://dev.maxmind.com/geoip/geoip2/downloadable/" target="_blank" rel="noopener noreferrer">downloads<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> page. I couldn't find a super easy guide for the new <strong>GeoIP2</strong> so here I am putting all the steps in case I need to do it again or if someone else is having issues with the other guides online. The guide is for Ubuntu but can be easily addapted to any Debian based systems.</p> <h3 id="download-the-nginx-source-and-the-geoip2-module"><a href="#download-the-nginx-source-and-the-geoip2-module" class="header-anchor">#</a> Download the nginx source and the geoip2 module.</h3> <p><em>You may want to update the link to the current version of nginx that you have installed</em></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">wget</span> http://nginx.org/download/nginx-1.16.1.tar.gz
<span class="token function">tar</span> zxvf nginx-1.16.1.tar.gz
<span class="token function">wget</span> https://github.com/leev/ngx_http_geoip2_module/archive/master.tar.gz ngx_http_geoip2_module.tar.gz
<span class="token function">tar</span> zxvf ngx_http_geoip2_module.tar.gz
</code></pre></div><h3 id="install-maxmind-s-ppa-and-the-libraries-required-to-build-nginx"><a href="#install-maxmind-s-ppa-and-the-libraries-required-to-build-nginx" class="header-anchor">#</a> Install Maxmind's ppa and the libraries required to build nginx</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">sudo</span> add-apt-repository ppa:maxmind/ppa
<span class="token function">apt</span> update
<span class="token function">apt</span> <span class="token function">install</span> libmaxminddb0 libmaxminddb-dev mmdb-bin geoipupdate 
<span class="token function">apt</span> <span class="token function">install</span> libpcre3 libpcre3-dev zlib1g zlib1g-dev libssl-dev
</code></pre></div><h3 id="regularly-update-the-geoip2-database"><a href="#regularly-update-the-geoip2-database" class="header-anchor">#</a> Regularly update the geoip2 database</h3> <p>Set a cronjob to update the geoip database.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">58</span> <span class="token number">13</span> * * <span class="token number">5</span> /usr/local/bin/geoipupdate <span class="token operator">&gt;&gt;</span> /dev/null <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span>
</code></pre></div><p>And it is good to run the update now so you have the latest data right away.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>geoipupdate
</code></pre></div><h3 id="build-nginx-with-the-geoip2-module"><a href="#build-nginx-with-the-geoip2-module" class="header-anchor">#</a> Build nginx with the geoip2 module</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> nginx-1.16.1
./configure  --add-dynamic-module<span class="token operator">=</span><span class="token punctuation">..</span>/ngx_http_geoip2_module-master <span class="token variable"><span class="token variable">$(</span>nginx -V<span class="token variable">)</span></span> --with-compat
<span class="token function">make</span>
</code></pre></div><p>Make sure to include <code>--with-compat</code> while executing <code>configure</code> because when you try to install the module you may get the following error:<br> <em>nginx: [emerg] module is not binary compatible</em></p> <h3 id="install-the-new-dynamic-module-in-nginx"><a href="#install-the-new-dynamic-module-in-nginx" class="header-anchor">#</a> Install the new dynamic module in nginx</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">cp</span> objs/ngx_http_geoip2_module.so /usr/lib/nginx/modules/
<span class="token builtin class-name">echo</span> <span class="token string">&quot;load_module modules/ngx_http_geoip2_module.so;&quot;</span> <span class="token operator">&gt;</span> /etc/nginx/modules-available/mod-http-geoip2.conf
<span class="token function">ln</span> -s /etc/nginx/modules-available/mod-http-geoip2.conf /etc/nginx/modules-enabled/60-mod-http-geoip2.conf
</code></pre></div><h3 id="setup-nginx"><a href="#setup-nginx" class="header-anchor">#</a> Setup nginx</h3> <p>In <code>/etc/nginx/nginx.conf</code> in <code>http</code> section add the following code to enable the geoip2 and automatically reload the databases if needed and pass the data to php with fastcgi params.</p> <div class="language-text extra-class"><pre class="language-text"><code>geoip2 /usr/share/GeoIP/GeoLite2-Country.mmdb {
    auto_reload 60m;
    $geoip2_metadata_country_build metadata build_epoch;
    $geoip2_data_country_code country iso_code;
    $geoip2_data_country_name country names en;
}

geoip2 /usr/share/GeoIP/GeoLite2-City.mmdb {
    auto_reload 60m;
    $geoip2_metadata_city_build metadata build_epoch;
    $geoip2_data_city_name city names en;
}

fastcgi_param COUNTRY_CODE $geoip2_data_country_code;
fastcgi_param COUNTRY_NAME $geoip2_data_country_name;
fastcgi_param CITY_NAME    $geoip2_data_city_name;
</code></pre></div><h3 id="how-to-block-countries"><a href="#how-to-block-countries" class="header-anchor">#</a> How to block countries</h3> <p>Again in <code>/etc/nginx/nginx.conf</code> in <code>http</code> section using a map with allowed/disallowed countries define a variable that you can use in the vhosts files.</p> <div class="language-text extra-class"><pre class="language-text"><code>map $geoip2_data_country_code $domain_xyz_allowed_country {
    default yes;
    BG no;
}
</code></pre></div><p>In the <strong>vhost configuration</strong> determine what to do if the country is not allowed. Usually block it.</p> <div class="language-text extra-class"><pre class="language-text"><code>location / {
    if ($domain_xyz_allowed_country = no) {
        return 444;
    }
}
</code></pre></div><h3 id="redirect-to-country-specific-domain"><a href="#redirect-to-country-specific-domain" class="header-anchor">#</a> Redirect to country-specific domain</h3> <p>Similar logic could be used for location redirect. For example if you have multiple domains for different countries (google.com for USA, google.bg for Bulgaria, etc).
To setup the dedirect use the <code>$geoip2_data_country_code</code> variable to decide whether or where the visitor should be redirected.</p> <p>In the <strong>vhost configuration</strong> of the main domain (e.g. <em>google.com</em>)</p> <div class="language-text extra-class"><pre class="language-text"><code>location / {
    if ($geoip2_data_country_code = BG) {
        return 301 https://google.bg$request_uri;
    }
}
</code></pre></div></div></div> <div class="post-meta"><span class="post-category">In <a href="/servers/" class="router-link-active">Servers</a></span> <span class="post-date">November 6, 2019</span></div> <div class="prev-next"><div class="prev"><!----></div> <div class="next"><a href="/depy/depy/"><strong>Depy - Simple and nearly dependency free deployment tool</strong></a></div></div></main></div></div> <footer class="footer"><div class="container">
            Copyright © 2006 - 2019 Ivan Dokov. All rights reserved.
        </div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.c1ca0c5b.js" defer></script><script src="/assets/js/4.4666041f.js" defer></script><script src="/assets/js/21.f2062736.js" defer></script>
  </body>
</html>
