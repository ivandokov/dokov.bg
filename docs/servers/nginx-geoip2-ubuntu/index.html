<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Installing Nginx with GeoIP2 on Ubuntu | Ivan Dokov - Web Expert</title>
    <meta name="description" content="Build nginx from source with GeoIP2 module">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700&amp;display=swap">
    
    <link rel="preload" href="/assets/css/0.styles.a08cb0de.css" as="style"><link rel="preload" href="/assets/js/app.7145d3d5.js" as="script"><link rel="preload" href="/assets/js/4.900d6e79.js" as="script"><link rel="preload" href="/assets/js/14.7d9a008d.js" as="script"><link rel="prefetch" href="/assets/js/1.9f88e0c1.js"><link rel="prefetch" href="/assets/js/10.c9e51687.js"><link rel="prefetch" href="/assets/js/11.2569ddd9.js"><link rel="prefetch" href="/assets/js/12.bde775d4.js"><link rel="prefetch" href="/assets/js/13.876e3cb3.js"><link rel="prefetch" href="/assets/js/15.1acae14d.js"><link rel="prefetch" href="/assets/js/16.469ec5b0.js"><link rel="prefetch" href="/assets/js/3.9722226f.js"><link rel="prefetch" href="/assets/js/5.7c38f7af.js"><link rel="prefetch" href="/assets/js/6.2b4fb946.js"><link rel="prefetch" href="/assets/js/7.190aeb18.js"><link rel="prefetch" href="/assets/js/8.fe9ef9a8.js"><link rel="prefetch" href="/assets/js/9.3647a2d1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a08cb0de.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="pb-12 px-3 md:px-0 font-sans text-secondary"><div class="container flex flex-wrap"><section class="max-h-screen overflow-auto md:sticky md:top-0 pt-12 w-full md:w-1/4 md:text-right"><div class="mb-10"><a href="/" class="block w-1/3 sm:w-1/5 md:w-auto mx-auto md:ml-4 lg:ml-16 md:mr-1 md:pr-10 router-link-active"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 199.6 55.5"><path fill="#4385ef" d="M15.2 55.5c-3.7-1-6.3-2.7-7.9-5S5 45.5 5 42.3v-5.8c0-1.9-.4-3.3-1.2-4.4-.8-1-2.1-1.6-3.8-1.6v-5.7c1.7 0 3-.5 3.8-1.5.8-1 1.2-2.4 1.2-4.3v-5.8c0-3.2.8-6 2.4-8.2 1.6-2.3 4.2-3.9 7.9-5l1.6 4.5c-1.6.6-2.7 1.6-3.4 3.1-.7 1.5-1 3.4-1 5.6V19c0 2-.4 3.7-1.3 5.2-.8 1.5-2.1 2.7-3.8 3.6 1.7.9 3 2.1 3.8 3.6.8 1.5 1.3 3.2 1.3 5.2v5.8c0 2.2.3 4.1 1 5.6s1.8 2.5 3.4 3.1l-1.7 4.4z"></path><path fill="#3F454C" d="M21.7 48.3V7h14.2c5 0 9.2 1.6 12.5 4.8 3.3 3.2 4.9 7.4 4.9 12.4V31c0 5.1-1.6 9.2-4.9 12.4-3.3 3.2-7.4 4.8-12.5 4.8H21.7zM30 13.4v28.5h5.5c3 0 5.3-1 7-3 1.7-2 2.5-4.6 2.5-7.9v-6.9c0-3.2-.8-5.8-2.5-7.8s-4-3-7-3H30zM57.8 32.7c0-4.6 1.3-8.3 3.8-11.2 2.6-2.9 6.1-4.4 10.6-4.4s8.1 1.5 10.7 4.4 3.9 6.7 3.9 11.3v.6c0 4.6-1.3 8.4-3.8 11.3-2.6 2.9-6.1 4.4-10.6 4.4s-8.1-1.5-10.7-4.4c-2.6-2.9-3.8-6.7-3.8-11.3v-.7zm8.2.6c0 2.8.5 5 1.5 6.7 1 1.7 2.6 2.5 4.8 2.5 2.1 0 3.7-.9 4.7-2.5 1-1.7 1.5-3.9 1.5-6.7v-.6c0-2.7-.5-4.9-1.5-6.7-1-1.7-2.6-2.6-4.7-2.6s-3.7.9-4.7 2.6c-1 1.7-1.5 3.9-1.5 6.6v.7zM102.4 35.5h-2.3v12.9h-8.3V4h8.3v25.1h2l7.1-11.5h9.6L109 31.5l11.3 16.8h-9.5l-8.4-12.8zM121.7 32.7c0-4.6 1.3-8.3 3.8-11.2 2.6-2.9 6.1-4.4 10.6-4.4s8.1 1.5 10.7 4.4 3.9 6.7 3.9 11.3v.6c0 4.6-1.3 8.4-3.8 11.3-2.6 2.9-6.1 4.4-10.6 4.4s-8.1-1.5-10.7-4.4c-2.6-2.9-3.8-6.7-3.8-11.3v-.7zm8.3.6c0 2.8.5 5 1.5 6.7 1 1.7 2.6 2.5 4.8 2.5 2.1 0 3.7-.9 4.7-2.5 1-1.7 1.5-3.9 1.5-6.7v-.6c0-2.7-.5-4.9-1.5-6.7-1-1.7-2.6-2.6-4.7-2.6s-3.7.9-4.7 2.6c-1 1.7-1.5 3.9-1.5 6.6v.7zM166.4 36.9l.5 2.8h.2l.6-2.8 5-19.3h8.7L171 48.3h-8l-10.4-30.7h8.7l5.1 19.3z"></path><path fill="#4385ef" d="M182.8 51c1.6-.6 2.7-1.6 3.4-3.1.7-1.5 1-3.4 1-5.6v-5.8c0-2 .4-3.7 1.3-5.2s2.2-2.7 4-3.5c-1.8-.9-3.1-2-4-3.6-.9-1.5-1.3-3.3-1.3-5.3v-5.8c0-2.2-.3-4.1-1-5.6s-1.8-2.5-3.4-3.1l1.6-4.5c3.7 1 6.3 2.7 7.9 5 1.6 2.3 2.4 5 2.4 8.2V19c0 1.9.4 3.4 1.2 4.4.8 1 2.1 1.5 3.8 1.5v5.7c-1.7 0-3 .5-3.8 1.6-.8 1-1.2 2.5-1.2 4.4v5.8c0 3.2-.8 6-2.4 8.3-1.6 2.3-4.2 3.9-7.9 5l-1.6-4.7z"></path></svg></a></div> <div class="py-1"><aside class="md:pr-10 md:border-r border-gray-100"><nav class="mb-5 -mt-2 text-center md:text-right"><div class="inline md:block -mr-1 mb-5"><a href="/" class="p-2 hover:text-primary hover:underline router-link-active text-primary">Blog</a> <a href="/about/" class="p-2 hover:text-primary hover:underline">About</a></div> <div class="inline md:block ml-2 md:ml-0 text-xs text-gray-500"><a href="https://github.com/ivandokov" target="_blank" class="p-1 hover:text-primary hover:underline">GitHub</a> <a href="https://twitter.com/ivandokov" target="_blank" class="p-1 hover:text-primary hover:underline">Twitter</a> <a href="#" class="p-1 hover:underline">Email</a> <a href="/rss.xml" class="p-1 hover:underline">RSS</a></div></nav> <nav class="mb-5 font-sm text-center md:text-right"><div class="inline md:block"><a href="/" class="p-2 md:p-0 whitespace-no-wrap router-link-active"><span class="hover:text-primary hover:underline">All posts</span> <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-gray-100 text-gray-500 text-xs">5</span></a></div> <div class="inline md:block"><a href="/bootstrap/" class="p-2 md:p-0 whitespace-no-wrap"><span class="hover:text-primary hover:underline">Bootstrap</span> <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-gray-100 text-gray-500 text-xs">1</span></a></div><div class="inline md:block"><a href="/depy/" class="p-2 md:p-0 whitespace-no-wrap"><span class="hover:text-primary hover:underline">Depy</span> <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-gray-100 text-gray-500 text-xs">1</span></a></div><div class="inline md:block"><a href="/servers/" class="p-2 md:p-0 whitespace-no-wrap router-link-active text-primary"><span class="hover:text-primary hover:underline">Servers</span> <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-gray-100 text-gray-500 text-xs">1</span></a></div><div class="inline md:block"><a href="/tools/" class="p-2 md:p-0 whitespace-no-wrap"><span class="hover:text-primary hover:underline">Tools</span> <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-gray-100 text-gray-500 text-xs">2</span></a></div></nav> <div class="leading-tight"><input aria-label="Search" autocomplete="off" spellcheck="false" placeholder="Search" value="" class="w-full mb-2 px-2 py-1 text-xs text-center md:text-right outline-none border-b border-transparent focus:border-gray-100 text-secondary placeholder-gray-500 hover:placeholder-primary"> <!----></div></aside> <footer class="mb-5 pt-6 md:pr-10 md:border-r border-gray-100 text-xs text-gray-300 text-center md:text-right">
            Â© 2006 - 2019 Ivan Dokov
        </footer></div></section> <main class="w-full md:w-3/4 md:pl-10 md:pt-24 mt-6 text-lg leading-relaxed"><article><div class="content-body -mt-2 content__default"><h1 id="nginx-with-geoip2-on-ubuntu"><a href="#nginx-with-geoip2-on-ubuntu" class="header-anchor">#</a> Nginx with GeoIP2 on Ubuntu</h1> <p>In the web you can find a lot of tutorials how to use the GeoIP module for nginx but Maxmind - the company that is providing the database for countries and cities is deprecating their old database format <strong>dat</strong> and replacing it with a new format - <strong>mmdb</strong>. The nginx setup for this new format is different and requires building the module from source since there is no official support for nginx provided by the company as stated in their <a href="https://dev.maxmind.com/geoip/geoip2/downloadable/" target="_blank" rel="noopener noreferrer">downloads<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> page. I couldn't find a super easy guide for the new <strong>GeoIP2</strong> so here I am putting all the steps in case I need to do it again or if someone else is having issues with the other guides online. The guide is for Ubuntu but can be easily addapted to any Debian based systems.</p> <h3 id="download-the-nginx-source-and-the-geoip2-module"><a href="#download-the-nginx-source-and-the-geoip2-module" class="header-anchor">#</a> Download the nginx source and the geoip2 module.</h3> <p><em>You may want to update the link to the current version of nginx that you have installed</em></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">wget</span> http://nginx.org/download/nginx-1.16.1.tar.gz
<span class="token function">tar</span> zxvf nginx-1.16.1.tar.gz
<span class="token function">wget</span> https://github.com/leev/ngx_http_geoip2_module/archive/master.tar.gz ngx_http_geoip2_module.tar.gz
<span class="token function">tar</span> zxvf ngx_http_geoip2_module.tar.gz
</code></pre></div><h3 id="install-maxmind-s-ppa-and-the-libraries-required-to-build-nginx"><a href="#install-maxmind-s-ppa-and-the-libraries-required-to-build-nginx" class="header-anchor">#</a> Install Maxmind's ppa and the libraries required to build nginx</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">sudo</span> add-apt-repository ppa:maxmind/ppa
<span class="token function">apt</span> update
<span class="token function">apt</span> <span class="token function">install</span> libmaxminddb0 libmaxminddb-dev mmdb-bin geoipupdate 
<span class="token function">apt</span> <span class="token function">install</span> libpcre3 libpcre3-dev zlib1g zlib1g-dev libssl-dev
</code></pre></div><h3 id="regularly-update-the-geoip2-database"><a href="#regularly-update-the-geoip2-database" class="header-anchor">#</a> Regularly update the geoip2 database</h3> <p>Set a cronjob to update the geoip database.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">58</span> <span class="token number">13</span> * * <span class="token number">5</span> /usr/local/bin/geoipupdate <span class="token operator">&gt;&gt;</span> /dev/null <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span>
</code></pre></div><p>And it is good to run the update now so you have the latest data right away.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>geoipupdate
</code></pre></div><h3 id="build-nginx-with-the-geoip2-module"><a href="#build-nginx-with-the-geoip2-module" class="header-anchor">#</a> Build nginx with the geoip2 module</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> nginx-1.16.1
./configure  --add-dynamic-module<span class="token operator">=</span><span class="token punctuation">..</span>/ngx_http_geoip2_module-master <span class="token variable"><span class="token variable">$(</span>nginx -V<span class="token variable">)</span></span> --with-compat
<span class="token function">make</span>
</code></pre></div><p>Make sure to include <code>--with-compat</code> while executing <code>configure</code> because when you try to install the module you may get the following error:<br> <em>nginx: [emerg] module is not binary compatible</em></p> <h3 id="install-the-new-dynamic-module-in-nginx"><a href="#install-the-new-dynamic-module-in-nginx" class="header-anchor">#</a> Install the new dynamic module in nginx</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">cp</span> objs/ngx_http_geoip2_module.so /usr/lib/nginx/modules/
<span class="token builtin class-name">echo</span> <span class="token string">&quot;load_module modules/ngx_http_geoip2_module.so;&quot;</span> <span class="token operator">&gt;</span> /etc/nginx/modules-available/mod-http-geoip2.conf
<span class="token function">ln</span> -s /etc/nginx/modules-available/mod-http-geoip2.conf /etc/nginx/modules-enabled/60-mod-http-geoip2.conf
</code></pre></div><h3 id="setup-nginx"><a href="#setup-nginx" class="header-anchor">#</a> Setup nginx</h3> <p>In <code>/etc/nginx/nginx.conf</code> in <code>http</code> section add the following code to enable the geoip2 and automatically reload the databases if needed and pass the data to php with fastcgi params.</p> <div class="language-text extra-class"><pre class="language-text"><code>geoip2 /usr/share/GeoIP/GeoLite2-Country.mmdb {
    auto_reload 60m;
    $geoip2_metadata_country_build metadata build_epoch;
    $geoip2_data_country_code country iso_code;
    $geoip2_data_country_name country names en;
}

geoip2 /usr/share/GeoIP/GeoLite2-City.mmdb {
    auto_reload 60m;
    $geoip2_metadata_city_build metadata build_epoch;
    $geoip2_data_city_name city names en;
}

fastcgi_param COUNTRY_CODE $geoip2_data_country_code;
fastcgi_param COUNTRY_NAME $geoip2_data_country_name;
fastcgi_param CITY_NAME    $geoip2_data_city_name;
</code></pre></div><h3 id="how-to-block-countries"><a href="#how-to-block-countries" class="header-anchor">#</a> How to block countries</h3> <p>Again in <code>/etc/nginx/nginx.conf</code> in <code>http</code> section using a map with allowed/disallowed countries define a variable that you can use in the vhosts files.</p> <div class="language-text extra-class"><pre class="language-text"><code>map $geoip2_data_country_code $domain_xyz_allowed_country {
    default yes;
    BG no;
}
</code></pre></div><p>In the <strong>vhost configuration</strong> determine what to do if the country is not allowed. Usually block it.</p> <div class="language-text extra-class"><pre class="language-text"><code>location / {
    if ($domain_xyz_allowed_country = no) {
        return 444;
    }
}
</code></pre></div><h3 id="redirect-to-country-specific-domain"><a href="#redirect-to-country-specific-domain" class="header-anchor">#</a> Redirect to country-specific domain</h3> <p>Similar logic could be used for location redirect. For example if you have multiple domains for different countries (google.com for USA, google.bg for Bulgaria, etc).
To setup the dedirect use the <code>$geoip2_data_country_code</code> variable to decide whether or where the visitor should be redirected.</p> <p>In the <strong>vhost configuration</strong> of the main domain (e.g. <em>google.com</em>)</p> <div class="language-text extra-class"><pre class="language-text"><code>location / {
    if ($geoip2_data_country_code = BG) {
        return 301 https://google.bg$request_uri;
    }
}
</code></pre></div></div> <aside class="border border-l-0 border-r-0 border-gray-300 my-12 py-10 text-xs text-gray-500">
        In <a href="/servers/" class="text-primary hover:underline router-link-active">Servers</a> November 6, 2019
    </aside> <aside class="flex leading-tight"><div class="w-1/2 pr-2"><!----></div> <div class="w-1/2 pl-2 text-right"><a href="/depy/depy/"><strong>Depy - Simple and nearly dependency free deployment tool</strong></a></div></aside></article></main></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.7145d3d5.js" defer></script><script src="/assets/js/4.900d6e79.js" defer></script><script src="/assets/js/14.7d9a008d.js" defer></script>
  </body>
</html>
